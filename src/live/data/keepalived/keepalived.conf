! Configuration File for keepalived

global_defs {

}

# Try to prevent the secondary DNS VIP from being active on the same node
vrrp_script pass_if_ip_not_exists_dns1 {
  script "/etc/keepalived/scripts/pass_if_ip_not_exists.sh %VIRTUAL_IP_ADDRESS_DNS1%"
  interval 2
  timeout 3
  fall 2
  rise 1
  weight 1
}

# Take out of rotation if dns not running
vrrp_script pass_if_service_active_dns {
  script "/etc/keepalived/scripts/pass_if_service_active.sh dns"
  interval 2
  timeout 3
  fall 2
  rise 1
  init_fail
}

# Take out of rotation if rke2-server not running
vrrp_script pass_if_service_active_rke2 {
  script "/etc/keepalived/scripts/pass_if_service_active.sh rke2-server"
  interval 2
  timeout 3
  fall 2
  rise 1
  init_fail
}

# Lower priority in live environment to avoid conflicts
vrrp_script pass_if_not_live_env {
  script "/etc/keepalived/scripts/pass_if_not_live_env.sh"
  interval 2
  timeout 3
  fall 2
  rise 1
  weight 10
  init_fail
}

vrrp_instance VI_1 {
    state MASTER
    interface %INTERFACE%
    virtual_router_id 101
    priority %PRIORITY%
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass 1111
    }
    virtual_ipaddress {
        %VIRTUAL_IP_ADDRESS_KUBE%
    }
    track_script {
        pass_if_service_active_rke2
        pass_if_not_live_env
    }
}

vrrp_instance VI_2 {
    state MASTER
    interface %INTERFACE%
    virtual_router_id 102
    priority %PRIORITY%
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass 1111
    }
    virtual_ipaddress {
        %VIRTUAL_IP_ADDRESS_DNS1%
    }
    track_script {
        pass_if_service_active_dns
        pass_if_not_live_env
    }
}

vrrp_instance VI_3 {
    state MASTER
    interface %INTERFACE%
    virtual_router_id 103
    priority %PRIORITY%
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass 1111
    }
    virtual_ipaddress {
        %VIRTUAL_IP_ADDRESS_DNS2%
    }
    track_script {
        pass_if_ip_not_exists_dns1
        pass_if_service_active_dns
        pass_if_not_live_env
    }
}